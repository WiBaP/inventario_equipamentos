<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Invent√°rio de Dispositivos</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>

<body class="bg-light">

<div class="container mt-4">

    <h2 class="mb-4">Invent√°rio de Dispositivos</h2>

    <div class="d-flex mb-3">
    <input id="pesquisa"
           class="form-control me-2"
           placeholder="Pesquisar..."
           onkeydown="if (event.key === 'Enter') pesquisar()">
    </div>

    <div class="d-flex align-items-center gap-2 mb-3">

    <span class="badge bg-secondary">
    Total: <span id="totalNotas">0</span>
    </span>

    <span class="badge bg-success">
    Com termo: <span id="totalComTermo">0</span>
    </span>

    <span class="badge bg-danger">
    Sem termo: <span id="totalSemTermo">0</span>
    </span>


    <div class="ms-auto btn-group">
        <button class="btn btn-outline-secondary btn-sm" onclick="aplicarFiltro('todos')">
            Todos
        </button>
        <button class="btn btn-outline-success btn-sm" onclick="aplicarFiltro('verde')">
            Com termo
        </button>
        <button class="btn btn-outline-danger btn-sm" onclick="aplicarFiltro('vermelho')">
            Sem termo
        </button>
    </div>

    </div>
        <button class="btn btn-primary" onclick="listar()">Listar Todos</button>
        <button class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#modalAdd">
            Adicionar Dispositivo
        </button>

        <button class="btn btn-warning ms-2" onclick="abrirPendentes()">
            Pendentes de Retirada
        </button>
    </div>

    <table class="table table-striped">
        <thead>
        <tr>
            <th>Hostname</th>
            <th>Serial</th>
            <th>Fabricante</th>
            <th>Modelo</th>
            <th>CPU</th>
            <th>Mem√≥ria</th>
            <th>√öltimo Usu√°rio</th>
            <th>Status</th>
            <th>Estado</th>
            <th>OBS</th>
            <th>A√ß√µes</th>
        </tr>
        </thead>
        <tbody id="tabela"></tbody>
    </table>
</div>

<!-- Modal de adicionar dispositivo -->
<div class="modal fade" id="modalAdd" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar Dispositivo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>

            </div>

            <div class="modal-body">
                <input class="form-control mb-2" id="add_hostname" placeholder="Hostname">
                <input class="form-control mb-2" id="add_serial" placeholder="Serial">
                <input class="form-control mb-2" id="add_fabricante" placeholder="Fabricante">
                <input class="form-control mb-2" id="add_modelo" placeholder="Modelo">
                <input class="form-control mb-2" id="add_cpu" placeholder="CPU">
                <input class="form-control mb-2" id="add_memoria" placeholder="Mem√≥ria">
                <input class="form-control mb-2" id="add_ultimo" placeholder="√öltimo Usu√°rio">
                <input class="form-control mb-2" id="add_status" placeholder="Status">
                <input class="form-control mb-2" id="add_estado" placeholder="Estado">
                <input class="form-control mb-2" id="add_obs" placeholder="obs">
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-success" onclick="adicionar()">Salvar</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal Abrir Termo -->
<div class="modal fade" id="modalVisualizarTermo" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="tituloTermoModal">Visualizar Termo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-center">
        
        <a id="linkVisualizar" href="#" class="btn btn-primary" target="_blank">
          Download
        </a>

        <button class="btn btn-warning mt-3" id="btnAlterarTermo" onclick="abrirAlterarTermo()">
          Alterar Termo
        </button>

      </div>

    </div>
  </div>
</div>

<!-- Modal Pendentes -->
<div class="modal fade" id="modalPendentes" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dispositivos Pendentes de Retirada</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <table class="table table-bordered">
                    <thead>
                    <tr>
                        <th>Hostname</th>
                        <th>√öltimo Usu√°rio</th>
                        <th>A√ß√£o</th>
                    </tr>
                    </thead>
                    <tbody id="tabelaPendentes"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Usuario existente -->
 <div class="modal fade" id="modalConflitoUsuario" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Usu√°rio j√° possui m√°quina</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p id="textoConflito"></p>

        <select id="acaoConflito" class="form-select">
          <option value="">Selecione uma a√ß√£o</option>
          <option value="manutencao">Colocar em Manuten√ß√£o</option>
          <option value="disponivel">Marcar como Dispon√≠vel</option>
          <option value="descarte">Enviar para Descarte</option>
          <option value="emprestado">Manter como Emprestado</option>
          <option value="permanece">Permanece com o usu√°rio</option>
        </select>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" onclick="confirmarConflito()">Confirmar</button>
      </div>

    </div>
  </div>
</div>

<!-- Modal Termo (Primeira etapa - Upload ou Gerar) -->
<div class="modal fade" id="modalTermo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Termo de Responsabilidade</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <input type="hidden" id="usuarioTermo">

                <!-- Upload PDF (opcional) -->
                <label class="form-label">Selecione um PDF j√° assinado (opcional):</label>
                <input
                    type="file"
                    class="form-control"
                    id="arquivoTermo"
                    accept="application/pdf"
                >

            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button class="btn btn-success" onclick="enviarTermo()">Enviar PDF</button>
                <button class="btn btn-primary" onclick="abrirModalAssinatura()">Gerar PDF</button>
            </div>

        </div>
    </div>
</div>

<!-- Modal Assinatura (Segunda etapa - Assinar) -->
<div class="modal fade" id="modalAssinatura" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Assinatura Digital</h5>
                <button class="btn-close" data-bs-dismiss="modal" onclick="voltarParaModalTermo()"></button>
            </div>

            <div class="modal-body">

                <div class="alert alert-info">
                    <strong>Aten√ß√£o:</strong> Por favor, assine no campo abaixo. No celular, use o dedo para desenhar sua assinatura.
                </div>

                <!-- Canvas de Assinatura -->
                <div class="border rounded p-2 mb-3" style="background-color: #f8f9fa;">
                    <canvas 
                        id="canvasAssinatura" 
                        width="600" 
                        height="200" 
                        style="border: 2px dashed #dee2e6; background-color: white; cursor: crosshair; touch-action: none; width: 100%; max-width: 600px; height: auto;"
                    ></canvas>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-warning" onclick="limparAssinatura()">
                            üóëÔ∏è Limpar Assinatura
                        </button>
                        <small class="text-muted ms-2">Desenhe sua assinatura acima</small>
                    </div>
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="voltarParaModalTermo()">Voltar</button>
                <button class="btn btn-success" onclick="finalizarEAssinar()">
                    ‚úçÔ∏è Assinar e Salvar PDF
                </button>
            </div>

        </div>
    </div>
</div>

<script>
// Vari√°veis do canvas
let canvas, ctx;
let desenhando = false;
let assinaturaVazia = true;

function abrirModalAssinatura() {
    const usuario = document.getElementById("usuarioTermo").value;
    
    if (!usuario) {
        alert("Usu√°rio n√£o foi definido!");
        return;
    }
    
    // Fechar modal termo e abrir modal assinatura
    const modalTermo = bootstrap.Modal.getInstance(document.getElementById('modalTermo'));
    modalTermo.hide();
    
    const modalAssinatura = new bootstrap.Modal(document.getElementById('modalAssinatura'));
    modalAssinatura.show();
    
    // Inicializar canvas ap√≥s modal abrir
    setTimeout(() => {
        inicializarCanvas();
    }, 300);
}

function voltarParaModalTermo() {
    const modalAssinatura = bootstrap.Modal.getInstance(document.getElementById('modalAssinatura'));
    modalAssinatura.hide();
    
    const modalTermo = new bootstrap.Modal(document.getElementById('modalTermo'));
    modalTermo.show();
    
    limparAssinatura();
}

function inicializarCanvas() {
    canvas = document.getElementById('canvasAssinatura');
    ctx = canvas.getContext('2d');
    
    // Configura√ß√µes do pincel
    ctx.strokeStyle = '#000000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    // Limpar canvas
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Eventos de mouse
    canvas.addEventListener('mousedown', iniciarDesenho);
    canvas.addEventListener('mousemove', desenhar);
    canvas.addEventListener('mouseup', pararDesenho);
    canvas.addEventListener('mouseleave', pararDesenho);
    
    // Eventos de touch (para celular)
    canvas.addEventListener('touchstart', iniciarDesenhoTouch);
    canvas.addEventListener('touchmove', desenharTouch);
    canvas.addEventListener('touchend', pararDesenho);
}

function iniciarDesenho(e) {
    desenhando = true;
    assinaturaVazia = false;
    const rect = canvas.getBoundingClientRect();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
}

function desenhar(e) {
    if (!desenhando) return;
    const rect = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.stroke();
}

function iniciarDesenhoTouch(e) {
    e.preventDefault();
    desenhando = true;
    assinaturaVazia = false;
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    ctx.beginPath();
    ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
}

function desenharTouch(e) {
    e.preventDefault();
    if (!desenhando) return;
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
    ctx.stroke();
}

function pararDesenho() {
    desenhando = false;
    ctx.beginPath();
}

function limparAssinatura() {
    if (canvas && ctx) {
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        assinaturaVazia = true;
    }
}

async function finalizarEAssinar() {
    const usuario = document.getElementById("usuarioTermo").value;
    
    if (!usuario) {
        alert("Usu√°rio n√£o foi definido!");
        return;
    }
    
    if (assinaturaVazia) {
        alert("Por favor, assine antes de continuar!");
        return;
    }
    
    // Converter canvas para base64
    const assinaturaBase64 = canvas.toDataURL('image/png').split(',')[1];
    
    console.log("üì§ Gerando e salvando PDF com assinatura...");
    console.log("üë§ Usu√°rio:", usuario);
    console.log("‚úçÔ∏è Assinatura (primeiros 50 chars):", assinaturaBase64.substring(0, 50)); // ‚Üê LOG NOVO
    console.log("üìè Tamanho da assinatura:", assinaturaBase64.length); // ‚Üê LOG NOVO
    
    try {
        const resp = await fetch(`/dispositivos/gerar-termo-usuario/${usuario}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                assinatura: assinaturaBase64 
            })
        });
        
        console.log("üì• Status da resposta:", resp.status); // ‚Üê LOG NOVO
        
        if (!resp.ok) {
            const error = await resp.json();
            alert(`Erro: ${error.detail}`);
            return;
        }

        const result = await resp.json();
        
        console.log("‚úÖ Resultado:", result); // ‚Üê LOG NOVO
        
        alert(`‚úÖ ${result.message}\n\nArquivo salvo: ${result.arquivo}`);
        
        // Fechar modal de assinatura
        const modalAssinatura = bootstrap.Modal.getInstance(document.getElementById('modalAssinatura'));
        modalAssinatura.hide();
        
        // Limpar assinatura
        limparAssinatura();
        
        console.log("‚úÖ PDF gerado e salvo com sucesso!");
        
    } catch (error) {
        console.error("‚ùå Erro:", error);
        alert("Erro ao gerar o PDF. Tente novamente.");
    }

}

// Fun√ß√£o original de envio (upload de PDF)
async function enviarTermo() {
    const arquivo = document.getElementById("arquivoTermo").files[0];
    
    if (!arquivo) {
        alert("Selecione um arquivo PDF!");
        return;
    }
    
    // Implementar l√≥gica de upload se necess√°rio
    alert("Fun√ß√£o de upload de PDF - implementar conforme necess√°rio");
}
</script>

<style>
#canvasAssinatura {
    display: block;
    margin: 0 auto;
}

@media (max-width: 768px) {
    .modal-dialog {
        margin: 0.5rem;
    }
    
    #canvasAssinatura {
        width: 100% !important;
        height: 150px !important;
    }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/static/app.js"></script>
</body>
</html>
